# **在服务器上后台运行程序的几种方法**

下载数据、科学计算动不动就要运行几个小时乃至好几天，这么长的时间一直保持ssh连接并不现实，所以我们都希望能在服务器上后台运行程序。本篇介绍几种后台运行程序的方法，各有优劣，以供大家查阅取用。

# 基本篇：`nohup ... &`

在服务器使用入门中就使用了这种方法：
```bash
nohup jupyter lab &
```

这其中涉及了两部分内容：`&`（放到后台运行）以及`nohup`（将原本输出在屏幕上的文本输出到文件）。

## `&`

默认情况下，进程是前台进程，前台运行命令时就把shell给占据了而无法进行其他操作。对于那些没有交互的进程，很多时候，我们希望将其在后台启动，可以在启动参数的时候加一个`&`实现这个目的。

这个符号放在bash命令最后面，可以让原本的命令转到后台运行。对于这样的命令，系统会创建一个sub-shell来运行这个命令。在执行命令之后，终端会显示所创建的sub-shell的线程ID（PID）：

```bash
$ ./test.py &
[1] 1337
```

进程切换到后台以后可以用`jobs`命令检查sub-shell的信息：

```bash
[1]+ Running          ./test.py &
```

对于切换到sub-shell的程序，使用命令`fg`可以把它拉回当前的shell。

```
$ fg
[1]  - 1337 continued  ./test.py
```

>注意当账户退出登录后，用`&`后台运行的进程也会随之终止，因此需要后面的内容。
## `nohup`

在使用了`&`后，命令的确转到后台运行了（直接按`<ctrl>+c`不能关掉进程了）；但是一旦账户退出登录进程还是会终止，而且对于像是jupyter-lab，wget这些会输出log的命令，它还是会把log输出到屏幕上，非常难受。于是`nohup`与`&`联合起来使用便可以将输出重定向至文件（不再把log直接输入到屏幕），并且账户退出登录后也能保持运行（no hang up）。

默认将输出重定向至当前目录下的`nohup.out`文件；如果当前目录下不可写，文件会放在`$HOME/nohup.out`。

使用了`nohup`之后，很多人就这样不管了，其实这样有可能在当前账户非正常退出或者结束的时候，命令还是自己结束了。所以在使用`nohup`命令后台运行命令之后，需要使用`exit`（或`<ctrl>+d`）正常退出当前账户，这样才能保证命令一直在后台运行。

## 后台进程需要寿终正寝

进程一直挂在后台占资源是不好的，因此我们需要学习怎样关闭我们放到后台的进程。
# 进阶篇：输出重定向至其他文件

想要将`nohup ... &`方法产生的`nohup.out`文件存储到其他地方？可以使用这个命令：

```bash
nohup jupyter lab > /data/public/jupyter.log 2>&1 &
```

什么什么？`2>&1`是什么鬼乱码？它的作用是把标准错误（例如程序运行报错）和标准输出（原本输出在屏幕上的文本）一起保存到一个文件中。想要理解这一过程，需要了解一点Linux中重定向的基本知识。

## 重定向输出

每个程序在开始运行时，都会至少打开三个文件描述符，分别是
- 0：标准输入(stdin)
- 1：标准输出(stdout)
- 2：标准错误(stderr)

例如有一条命令`~/test.sh`，可以进入`fd`目录检查：

```bash
ls -l /proc/<pid>/fd # 列出对应进程所有打开的文件描述符
 0 -> /dev/pts/7
 1 -> /dev/pts/7
 2 -> /dev/pts/7
 255 -> /home/<username>/test.sh
```

要将输出重定向至文件：

```bash
~/test.sh > log.txt
```

此时的文件描述符指向：

```bash
ls -l /proc/<pid>/fd # 列出对应进程所有打开的文件描述符
 0 -> /dev/pts/7
 1 -> /home/<username>/log.txt
 2 -> /dev/pts/7
 255 -> /home/<username>/test.sh
```

这时标准错误(即运行程序时有时候的报错)仍然没有输出到文件。只需将命令改为

```bash
~/test.sh > log.txt 2>&1
```

或

```bash
~/test.sh >& log.txt
~/test.sh &> log.txt
```

便可以文件描述符2的输出附加在1后，一起记录在文件`log.txt`中。这里的`&`加在1前是为了与文件名为"1"的文件作区别。

要想让程序没有输出，可以重定向至`/dev/null`，输入这个文件的数据会直接消失。

```bash
~/test.sh > /dev/null 2>&1
```

## 举个例子

比如说我要下载SDSS的光谱星表(https://data.sdss.org/sas/dr17/eboss/spectro/redux/v5_13_2/spAll-v5_13_2.fits)，花的时间可能有点久，于是挂到后台下载。

```bash
cd /data/public
nohup wget https://data.sdss.org/sas/dr17/eboss/spectro/redux/v5_13_2/spAll-v5_13_2.fits > ~/wget_231018.log 2>&1 &
```

然后就可以放心地退出登录等待下载完毕了。这一句是把wget默认显示在屏幕上的下载进度信息重定向到了自己家目录下的`wget_231018.log`。当然按照上一小节的内容也可以把重定向符号`>`改成`&>`或`>&`，然后省略`2>&1`。

还有如果我完全不想看到输出信息（不过下载文件的话不建议这样……），直接重定向到`/dev/null`。输出信息消失的无影无踪，有时候很爽。

# 飞升篇：tmux

这一节介绍一个工具tmux，它可以字面意义上让你运行程序的会话飞升出来，除此之外还可以一个窗口开好几个终端，资深程序员都喜欢用。tmux的功能很强大很复杂，本文仅限介绍有关会话的基本操作，让会话和窗口脱耦来实现后台运行程序；分屏(pane)的操作在此不涉及。

## 创建tmux会话

终端下输入命令

```bash
tmux
```

会创建一个会话(session)。tmux的会话有一个名字，默认是通过数字编号来命名的。有些时候我们要指定会话的名字，使用下面的命令：

```bash
tmux new -s <session-name>
```

比如说，我创建一个会话专门用来跑source-extractor，把它命名成"sextractor"这样以后更好找。

运行了这个命令我们就成功进入tmux会话中了。

## 离开tmux会话(使其后台运行)

使用快捷键：`<ctrl>+b,d`（这个意思是先按`<ctrl>+b`，再按`d`）；这样tmux会
话便会与窗口解耦，在后台自己运行。

tmux中的快捷键基本是以`<ctrl>+b`起手，跟上其他的按键；要想查看可用的快捷键可以用`<ctrl>+b.?`来调出快捷键列表，用键盘上下键翻页查看。

## 查看tmux会话列表

在tmux会话外，使用命令

```bash
tmux ls
```

可以查看你有几个会话正在运行。

## 重新连接到tmux会话

在tmux会话外，使用命令

```bash
tmux attach -t <id>
```

重新连接到0号会话，`<id>`对应`tmux ls`输出中的数字（或者是你在创建是给它起的名字，匹配上一部分就行）。

## 关闭（杀死）tmux会话

在tmux会话中，输入命令`exit`或`<ctrl>+d`来退出会话。

在tmux会话外，输入命令

```bash
tmux kill-session -t <id>
```

来指定一个会话干掉它。

## 用tmux后台运行程序的流程

- 新建会话：`tmux new -s <name>`
- 在会话中运行程序
- 离开会话：`<ctrl>+b,d`
- 重新连接会话以检查运行状态：`tmux attach -t <id>`
- 运行完毕，杀死会话

优点在于灵活。
## tmux的更多应用

tmux还可以在一个window里开若干个pane，使用命令

```bash
tmux split-window [-h] # 分割窗口；-h表示horizontal，将区域分为上下两个pane
tmux select-pane [-U/-D/-L/-R] # 将光标移动到上/下/左/右的pane中
```

更便捷的方式是通过快捷键：
- `<ctrl>+b,<up-arrow>`：移动到上方的pane
- `<ctrl>+b,<down-arrow>`：……
- `<ctrl>+b,x`：关闭当前pane
- `<ctrl>+b,w`：从列表中选择会话
- ……

此外可以通过安装插件增强tmux的功能(https://github.com/gpakosz/.tmux, etc.)，快捷键也可以通过配置文件自己定义。
